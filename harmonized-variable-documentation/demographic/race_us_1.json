{
  "name": "race_us_1",
  "phenotype_concept": "race_us",
  "concept_variant": 1,
  "description": "Reported race of participant according to the United States administrative definition of race.",
  "version": 1,
  "dcc_harmonization_id": 157,
  "data_type": "encoded",
  "measurement_units": null,
  "has_age_variable": false,
  "date_harmonized": "2019-10-29 10:12:49",
  "dcc_harmonization_comments": "The values for this harmonized variable are largely concordant with the Office of Management and Budget (OMB) race categories[^1], but ultimately rely on if and how each study asked subjects about their race and ethnicity. This harmonized variable only includes studies where all or most subjects were recruited in the U.S. Subjects in studies that recruited all subjects outside the U.S. were not included in this harmonized variable.\n\nSome studies included the option \"`Asian or Pacific Islander`\" (in contrast to separate options of \"`Native Hawaiian/Pacific Islander`\" and \"`Asian`\"). In these cases, the value assigned for this variable was \"`Asian`\". If a component study variable included the option of Hispanic/Latino, \"`Other`\" was assigned for this variable unless there was additional information to allow for a specific race value to be assigned. Information about Hispanic/Latino origin is provided in the harmonized variable `hispanic_or_latino_1.` In addition to \"`Other`\" being assigned in this way, some studies had questionnaires where \"`Other`\" was an option to select for race. In these cases, the value \"`Other`\" was used for these subjects in this harmonized variable.\n\nFor studies with multiple component variables asking for \"`Yes`\" or \"`No`\" for various race options, if a subject indicated \"`Yes`\" for more than one race option, the value \"`Multiple`\" was assigned for this variable. For studies/subcohorts with multiple visits and comparable race/ethnicity questions, if race values were inconsistent across visits, the value \"`Multiple`\" was assigned for this variable.\n\nPlease note that the \"`Other`\" and \"`Multiple`\" encoded values are very heterogeneous and are not intended to be used directly in analysis. If this variable is used in analysis, analysts should either exclude subjects who were assigned to either of these encoded values or decide how to appropriately group the subjects with these values.\n\nIt is expected that most values for this harmonized variable are from self-report of study subjects; however, this cannot be guaranteed in all cases. For some subjects, it is possible that a race value was assigned by a member of the research team. Indeed, for several studies it is known that race is not directly from self-report but rather was inferred from the study recruitment criteria and/or confirmed by study investigators. \n\n### Study-specific comments\n\n#### Amish\n\nAll consented subjects were assigned the value  \"`White`\" for this harmonized variable, which was confirmed by study investigators.\n\n#### ARIC\n\nComponent variables for *ARIC* include study variables from multiple visits.\n\n#### CFS\n\nComponent variables for *CFS* include study variables from multiple visits.\n\n#### FHS\n\nAll consented subjects from the *FHS* Original subcohort were assigned the value \"`White`\" for this harmonized variable, which was confirmed by study investigators.\n\nComponent variables for *FHS* Generation 3, New Offspring Spouse, and Omni 2 subcohorts include study variables from multiple visits.\n\n*FHS* Offspring and Omni 1 subcohorts only used component variables from one visit.\n\n#### GALAII\n\nAll consented subjects were assigned the value \"`Other`\" for this harmonized variable, which was confirmed by study investigators.\n\n#### GOLDN\n\nAll consented subjects were assigned the value \"`White`\" for this harmonized variable based on recruitment criteria.\n\n#### HCHS_SOL\n\nAll consented subjects were assigned the value \"`Other`\" for this harmonized variable, which was confirmed by study investigators.\n\n#### JHS\n\nAll consented subjects were assigned the value \"`Black`\" for this harmonized variable, which was confirmed by study investigators.\n\n#### MESA\n\nComponent variables for *MESA* AirNR and Classic subcohorts include study variables from multiple visits.\n\n*MESA* Family subcohort only used component variables from one visit.\n\n#### WHI \n\n*WHI* ascertained race using two forms, one with broader race options and the second with more specific options, but the broader form took precedence according to study investigators. In this harmonization the second form was used to determine the assignment of \"`Native Hawaiian/Pacific Islander`\" over \"`Asian`\". Subjects who selected more than one option on the second form were not assigned to \"`Multiple`\".  See harmonization algorithm for more details.\n\n\n[^1]: Revisions to the Standards for the Classification of Federal Data on Race and Ethnicity, 62 Fed. Reg. 210 (October 30, 1997). *Federal Register: The Daily Journal of the United States*. \n\n",
  "encoded_values": [
    {
      "code": "AI_AN",
      "value": "American Indian, Alaskan Native, or Native American"
    },
    {
      "code": "Asian",
      "value": "Asian"
    },
    {
      "code": "Black",
      "value": "Black or African American"
    },
    {
      "code": "HI_PI",
      "value": "Native Hawaiian or other Pacific Islander"
    },
    {
      "code": "Multiple",
      "value": "More than one race"
    },
    {
      "code": "Other",
      "value": "Other race"
    },
    {
      "code": "White",
      "value": "White or Caucasian"
    }
  ],
  "controlled_vocabulary": [
    {
      "source": "UMLS",
      "version": "2019AA",
      "id": "C0034510"
    }
  ],
  "harmonization_units": [
    {
      "name": "Amish",
      "component_study_variables": ["phs000956.v3.pht005000.v1.phv00252969.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n    source_data <- phen_list$source_data\n    dat <- source_data[[\"pht005000\"]]\n\n  # confirmed with PI that all subjects are Amish; set race_us = White\n  # pull in subject file and eliminate consent=0 subjects\n\n   dat <- dat %>% filter(!is.element(CONSENT, 0)) %>%\n        mutate(race_us = \"White\") %>%\n        select(topmed_subject_id, race_us)\n\n   return(dat)\n}\n"
    },
    {
      "name": "ARIC",
      "component_study_variables": ["phs000280.v5.pht004062.v2.phv00204633.v1", "phs000280.v5.pht004063.v2.phv00204710.v1", "phs000280.v5.pht004065.v2.phv00204962.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us and hispanic_or_latino for ARIC\n # A=Asian/Pacific Islander;B=Black;I=American Indian or Alaskan Indian;W=White\n\n   source_data <- phen_list$source_data\n\n   # visit 1 data\n\n    dat1 <- source_data[[\"pht004063\"]]\n\n   # visit 2 data\n    dat2 <- source_data[[\"pht004062\"]]\n\n   # visit 4 data\n    dat4 <- source_data[[\"pht004065\"]]\n\n   dat <- rbind(dat1, dat2, dat4)\n\n   dat$race_us <- dat$RACEGRP\n   dat$race_us[dat$race_us %in% \"A\"] <- \"Asian\"\n   dat$race_us[dat$race_us %in% \"B\"] <- \"Black\"\n   dat$race_us[dat$race_us %in% \"I\"] <- \"AI_AN\"\n   dat$race_us[dat$race_us %in% \"W\"] <- \"White\"\n\n   dat <- dat %>% filter(!is.na(race_us)) %>% tbl_df() %>%\n       arrange(topmed_subject_id) %>%\n        group_by(topmed_subject_id)\n\n  # determine number of unique race categories chosen across visits for each subject\n   sdat <- dat %>% summarise(ncatr = length(unique(race_us)))\n\n   datt <- inner_join(dat, sdat)\n\n  # if subject chose more than one race category across visits, assign race_us = Multiple\n   selr <- datt$ncatr > 1\n   datt$race_us[selr] <- \"Multiple\"\n\n  # slice(1) chooses the first entry for each subject (all entries per subject are now the same)\n   datt <- datt %>% filter(!is.na(race_us)) %>% slice(1) %>%\n          select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "CARDIA",
      "component_study_variables": ["phs000285.v3.pht001645.v2.phv00115113.v2"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us for CARDIA\n    source_data <- phen_list$source_data\n\n ## study document for B2REF (pht001645) says:\n #  This file contains the demographic variables (age, sex, race, education)\n # and should be used in any analysis of the CARDIA cohort requiring stratification\n # by the demographic variables.\n #  The variables SEX and RACE are based on the original demographic variables collected in Exam 1\n # and verified in Exam 2.\n #  This reference file is the only file in this version of the CARDIA data that contains\n # information on all original participants.\n #  Document for A4REF from Exam1 states:\n # THE FOLLOWING CODE IMPLEMENTS ONLY TWO CODES FOR THE RACE VARIABLE\n #  5 - WHITE AND 4 - BLACK\n # Only 2 codes were carried forward\n\n   dat <- source_data[[\"pht001645\"]]\n\n   dat$race_us <- NA\n   dat$race_us[dat$RACE %in% 4] <- \"Black\"\n   dat$race_us[dat$RACE %in% 5] <- \"White\"\n\n   dat <- dat %>% filter(!is.na(race_us)) %>% select(topmed_subject_id, race_us)\n\n   return(dat)\n}\n"
    },
    {
      "name": "CCAF",
      "component_study_variables": ["phs001189.v2.pht005979.v2.phv00273549.v2"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n  library(dplyr)\n\n  # Get dataset.\n  dataset <- phen_list$source_data$pht005979 %>%\n             rename(race_us = race)\n\n  # Substitute encoded race values.\n  dataset$race_us[dataset$race_us %in% 'white'] <- 'White'\n\n  # Substitute the value of 'NA' to missing.\n  dataset$race_us[dataset$race_us %in% 'NA'] <- NA\n\n  # Remove records with NAs from dataset.\n  dataset <- na.omit(dataset)\n\n  return(dataset)\n}\n"
    },
    {
      "name": "CFS",
      "component_study_variables": ["phs000284.v2.pht001902.v1.phv00122991.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n    source_data <- phen_list$source_data\n    dat <- source_data[[\"pht001902\"]]\n\n # 1=White or Caucasian; 2=Black or African American; 3=Asian; 4=Hispanic;\n#  5=Native American or Alaska Native;  6=More than one race\n # White if variable=1; Black if variable=2; Asian if variable=3; Other if variable=4;\n # AI_AN if variable = 5; Multiple if variable=6\n # dat has multiple entries per subject for different visits\n\n   rc <- c(\"White\", \"Black\", \"Asian\", \"Hispanic\", \"AI_AN\", \"Multiple\")\n   dat$race <- as.integer(dat$race)\n   dat$race <- rc[dat$race]\n\n   dat2 <- dat %>% tbl_df() %>%\n       arrange(topmed_subject_id) %>%\n        group_by(topmed_subject_id)\n\n   seh <- dat2$race %in% \"Hispanic\"\n   dat2$race[seh] <- \"Other\"\n   dat3 <- dat2[!is.na(dat2$race), ]\n\n  # determine number of unique race categories chosen across visits for each subject\n   sdat <- dat3 %>% summarise(ncatr = length(unique(race)), ot = is.element(\"Other\", race))\n\n   # if more than one race category (not including \"Other\") per subject across visits,\n   #   assign race = Multiple\n   datt <- inner_join(dat3, sdat)\n   selr <- datt$ncatr > 2\n   datt$race[selr] <- \"Multiple\"\n\n   so <- datt$ncatr == 2 & datt$ot == FALSE\n   datt$race[so] <- \"Multiple\"\n\n  # if race chosen as Other and one other race also chosen, assign the more specific race\n   se <- datt$ncatr == 2 & datt$ot == TRUE\n   sse <- se & datt$race %in% \"Other\"\n   datt <- datt[!sse, ]\n  # take out the \"Other\" entry so slice(1) (taking first entry per subject)\n  #  will capture the more specific race\n\n   datt <- datt %>% filter(!is.na(race)) %>% slice(1) %>%\n          select(topmed_subject_id, race_us = race)\n\n   return(datt)\n}\n"
    },
    {
      "name": "CHS_AfricanAmerican",
      "component_study_variables": ["phs000287.v6.pht001490.v1.phv00105645.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n    source_data <- phen_list$source_data\n    dat <- source_data[[\"pht001490\"]]\n\n # YR5 NEW file (NEW cohort)\n # 1=white;2=black; 3=American Indian or Alaska Native; 4= Asian/Pacific Islander; 5 = Other\n\n    dat <- dat %>% filter(!is.na(RACE01))\n\n   rc <- c(\"White\", \"Black\", \"AI_AN\", \"Asian\", \"Other\")\n   dat$race_us <- as.integer(dat$RACE01)\n   dat$race_us <- rc[dat$race_us]\n\n   datt <- dat %>% filter(!is.na(race_us)) %>%\n          select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "CHS_Original",
      "component_study_variables": ["phs000287.v6.pht001450.v1.phv00099569.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n    source_data <- phen_list$source_data\n    dat <- source_data[[\"pht001450\"]]\n\n # BASE1 file (Original, ie. OLD cohort)\n # 1=white;2=black; 3=American Indian or Alaska Native; 4= Asian/Pacific Islander; 5 = Other\n\n   dat <- dat %>% filter(!is.na(RACE01))\n\n   rc <- c(\"White\", \"Black\", \"AI_AN\", \"Asian\", \"Other\")\n   dat$race_us <- as.integer(dat$RACE01)\n   dat$race_us <- rc[dat$race_us]\n\n   datt <- dat %>% filter(!is.na(race_us)) %>%\n          select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "COPDGene",
      "component_study_variables": ["phs000179.v5.pht002239.v4.phv00159572.v4"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n    source_data <- phen_list$source_data\n    dat <- source_data[[\"pht002239\"]] %>%\n           rename(race_us = race)\n\n # harmonize race_us for COPDGene\n # 1=Caucasian; 2=African American; 3=Asian; 4=Pacific Islander;\n # 5= American Indian/Alaska; 6 = More than one race; 7 = Other\n\n   rc <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\", \"Multiple\", \"Other\")\n   dat <- dat[!is.na(dat$race_us), ]\n   dat$race_us <- as.integer(dat$race_us)\n   dat$race_us <- rc[dat$race_us]\n\n   return(dat)\n}\n"
    },
    {
      "name": "DHS",
      "component_study_variables": ["phs001412.v1.pht006746.v1.phv00310019.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n  library(dplyr)\n\n  # Dataset\n  dataset <- phen_list$source_data$pht006746 %>%\n             rename(race_us = RACE)\n  #Encoding race values\n  dataset$race_us[dataset$race_us %in% \"AA\"] <- \"Black\"\n\n  return(dataset)\n}\n"
    },
    {
      "name": "FHS_Gen3",
      "component_study_variables": ["phs000007.v30.pht000074.v11.phv00021244.v5", "phs000007.v30.pht000074.v11.phv00021245.v5", "phs000007.v30.pht000074.v11.phv00021246.v5", "phs000007.v30.pht000074.v11.phv00021247.v5", "phs000007.v30.pht000074.v11.phv00021248.v5", "phs000007.v30.pht000074.v11.phv00021249.v5", "phs000007.v30.pht000074.v11.phv00021250.v5", "phs000007.v30.pht000074.v11.phv00021251.v5", "phs000007.v30.pht000074.v11.phv00021398.v5", "phs000007.v30.pht003094.v5.phv00177238.v3", "phs000007.v30.pht003094.v5.phv00177597.v3", "phs000007.v30.pht003094.v5.phv00177598.v3", "phs000007.v30.pht003094.v5.phv00177599.v3", "phs000007.v30.pht003094.v5.phv00177600.v3", "phs000007.v30.pht003094.v5.phv00177601.v3", "phs000007.v30.pht003094.v5.phv00177602.v3", "phs000007.v30.pht003094.v5.phv00177603.v3"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us and hispanic_or_latino for FHS Generation 3\n # variables are 0/1 (no/yes) for given categories\n # White (Caucasian or White), Hispanic (Spanish/Hispanic/Latino)\n # Black (African-American or Black), Asian, HI_PI (Native Hawaiian or Pacific Islander\n # AI_AN (American Indian or Alaskan Native), Other, No (Prefer not to answer)\n # can choose more than one\n\n   source_data <- phen_list$source_data\n\n   # visit 1 data\n\n    dat1 <- source_data[[\"pht000074\"]]\n    dat1 <- dat1[dat1$IDTYPE %in% 3, ]\n    vars <- paste0(\"G3A\", 483:490)\n\n  #  rename variables; change 0/1 categorical to integer\n    nm <- c(\"White\", \"Hispanic\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\", \"Other\", \"No\")\n    for (i in 1:length(vars)){\n      dat1[, vars[i]] <- as.integer(dat1[, vars[i]])\n      names(dat1)[names(dat1) %in% vars[i]] <- nm[i]\n    }\n   w <- which(is.element(dat1, \".\"))\n   dat1[w] <- NA\n   dat1$race_us <- NA\n\n  # treat \"Hispanic\" differently\n   cnm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\", \"Other\")\n\n  # add up 0's and 1's across variables for each subject\n  # if sum =1 only chose one race category, if sum > 1 chose multiple race categories,\n  #   if sum = 0, did not choose any of the indicated categories\n   dat1$rs <- rowSums(dat1[, cnm], na.rm = TRUE)\n\n  # if only one category chosen, assign that category as the race\n   s1 <- dat1$rs %in% 1 & !(dat1$No %in% 1)\n   ws1 <- which(s1)\n   t2 <- dat1[s1, cnm]\n   wa <- which(t2 == 1, arr.ind = T)\n   dat1$race_us[ws1[wa[, 1]]] <- cnm[wa[, 2]]\n\n # if more than one race category chosen, assign race_us as \"Multiple\"\n   s3 <- dat1$rs > 1 & !(dat1$No %in% 1)\n   dat1$race_us[s3] <- \"Multiple\"\n\n # if Hispanic category chosen with no other race category, assign \"Other\"\n # person did choose to identify a race\n # ethnicity will be set to HL (i.e. is Hispanic)\n\n   s <- dat1$Hispanic %in% 1 & dat1$rs %in% 0\n   dat1$race_us[s] <- \"Other\"\n\n   dat1$race_us[dat1$No %in% 1] <- NA\n\n   dat1 <- dat1 %>% filter(!is.na(dat1$race_us)) %>% select(topmed_subject_id, race_us)\n\n   # visit 2 data - contains Gen3, NOS, Omni2\n   # Hispanic is not race choice but there is question re Hispanic ethnicity\n   # race is not affected by ethnicity\n   # here if chose ethnicity as Hispanic but no race - set race_us to Other if no other race choice\n\n    dat2 <- source_data[[\"pht003094\"]]\n    dat2 <- dat2[dat2$idtype %in% 3, ] # choose Gen3\n    vars <- paste0(\"g3b0\", 625:630)\n    nm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\", \"No\")\n    for (i in 1:length(vars)){\n      dat2[, vars[i]] <- as.integer(dat2[, vars[i]])\n      names(dat2)[names(dat2) %in% vars[i]] <- nm[i]\n    }\n   w <- which(is.element(dat2, \".\"))\n   dat2[w] <- NA\n   dat2$race_us <- NA\n\n   cnm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\")\n   dat2$rs <- rowSums(dat2[, cnm], na.rm = TRUE)\n\n  # if only one category chosen, assign that category as the race\n   s1 <- dat2$rs %in% 1 & !(dat2$No %in% 1)\n   ws1 <- which(s1)\n   t2 <- dat2[s1, cnm]\n   wa <- which(t2 == 1, arr.ind = T)\n   dat2$race_us[ws1[wa[, 1]]] <- cnm[wa[, 2]]\n\n # if more than one race category chosen, assign race_us as \"Multiple\"\n   s3 <- dat2$rs > 1 & !(dat2$No %in% 1)\n   dat2$race_us[s3] <- \"Multiple\"\n\n # no other race chosen but indicated Hispanic ethnicity, set race_us to Other\n   s <- dat2$g3b0624 %in% 1 & dat2$rs %in% 0\n   dat2$race_us[s] <- \"Other\"\n\n   dat2$race_us[dat2$No %in% 1] <- NA\n\n   dat2 <- dat2 %>% filter(!is.na(dat2$race_us)) %>% select(topmed_subject_id, race_us)\n\n # check for consistency across visits - if differ, assign race_us as \"Multiple\"\n   dat <- rbind(dat1, dat2)\n\n   dat <- dat %>% tbl_df() %>%\n       arrange(topmed_subject_id) %>%\n        group_by(topmed_subject_id)\n\n    # determine number of unique race categories chosen across visits for each subject\n   sdat <- dat %>% summarise(ncatr = length(unique(race_us)), ot = is.element(\"Other\", race_us))\n\n   # if more than one race category (not including \"Other\") per subject across visits,\n   #   assign race_us = Multiple\n   datt <- inner_join(dat, sdat)\n   selr <- datt$ncatr > 2\n   datt$race_us[selr] <- \"Multiple\"\n\n   so <- datt$ncatr == 2 & datt$ot == FALSE\n   datt$race_us[so] <- \"Multiple\"\n\n  # if race chosen as Other and one other race also chosen, assign the more specific race\n   se <- datt$ncatr == 2 & datt$ot == TRUE\n   sse <- se & datt$race_us %in% \"Other\"\n   datt <- datt[!sse, ]\n   # take out the \"Other\" entry so slice(1) (taking first entry per subject)\n#     will capture the more specific race\n\n   datt <- datt %>% filter(!is.na(race_us)) %>% slice(1) %>%\n          select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "FHS_NewOffspringSpouse",
      "component_study_variables": ["phs000007.v30.pht003094.v5.phv00177238.v3", "phs000007.v30.pht003094.v5.phv00177597.v3", "phs000007.v30.pht003094.v5.phv00177598.v3", "phs000007.v30.pht003094.v5.phv00177599.v3", "phs000007.v30.pht003094.v5.phv00177600.v3", "phs000007.v30.pht003094.v5.phv00177601.v3", "phs000007.v30.pht003094.v5.phv00177602.v3", "phs000007.v30.pht003094.v5.phv00177603.v3", "phs000007.v30.pht006005.v1.phv00273701.v1", "phs000007.v30.pht006005.v1.phv00274066.v1", "phs000007.v30.pht006005.v1.phv00274067.v1", "phs000007.v30.pht006005.v1.phv00274068.v1", "phs000007.v30.pht006005.v1.phv00274069.v1", "phs000007.v30.pht006005.v1.phv00274070.v1", "phs000007.v30.pht006005.v1.phv00274071.v1", "phs000007.v30.pht006005.v1.phv00274072.v1", "phs000007.v30.pht006005.v1.phv00274073.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us and hispanic_or_latino for FHS New Offspring Spouse\n # variables are 0/1 (no/yes) for given categories\n # White (Caucasian or White), Hispanic (Spanish/Hispanic/Latino)\n # Black (African-American or Black), Asian, HI_PI (Native Hawaiian or Pacific Islander\n # AI_AN (American Indian or Alaskan Native), Other, No (Prefer not to answer)\n # can choose more than one\n\n   source_data <- phen_list$source_data\n\n   # visit 1 data\n\n    dat1 <- source_data[[\"pht006005\"]]\n    dat1 <- dat1[dat1$idtype %in% 2, ]\n    vars <- paste0(\"g3a\", 483:490)\n    nm <- c(\"White\", \"Hispanic\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\", \"Other\", \"No\")\n\n  #  rename variables; change 0/1 categorical to integer\n   for (i in 1:length(vars)){\n      dat1[, vars[i]] <- as.integer(dat1[, vars[i]])\n      names(dat1)[names(dat1) %in% vars[i]] <- nm[i]\n    }\n   w <- which(is.element(dat1, \".\"))\n   dat1[w] <- NA\n   dat1$race_us <- NA\n\n  # treat \"Hispanic\" differently\n   cnm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\", \"Other\")\n\n  # add up 0's and 1's across variables for each subject\n  # if sum =1 only chose one race category, if sum > 1 chose multiple race categories,\n  #   if sum = 0, did not choose any of the indicated categories\n   dat1$rs <- rowSums(dat1[, cnm], na.rm = TRUE)\n\n  # if only one category chosen, assign that category as the race\n   s1 <- dat1$rs %in% 1 & !(dat1$No %in% 1)\n   ws1 <- which(s1)\n   t2 <- dat1[s1, cnm]\n   wa <- which(t2 == 1, arr.ind = T)\n   dat1$race_us[ws1[wa[, 1]]] <- cnm[wa[, 2]]\n\n # if more than one race category chosen, assign race_us as \"Multiple\"\n   s3 <- dat1$rs > 1 & !(dat1$No %in% 1)\n   dat1$race_us[s3] <- \"Multiple\"\n\n # if Hispanic category chosen with no other race category, assign \"Other\"\n # ethnicity will be set to HL (i.e. is Hispanic)\n\n   s <- dat1$Hispanic %in% 1 & dat1$rs %in% 0\n   dat1$race_us[s] <- \"Other\"\n\n   dat1$race_us[dat1$No %in% 1] <- NA\n\n   dat1 <- dat1 %>% filter(!is.na(dat1$race_us)) %>% select(topmed_subject_id, race_us)\n\n   # visit 2 data - contains Gen3, NOS, Omni2\n   # Hispanic is not race choice but there is question re Hispanic ethnicity\n   # set race_us to Other if no other race choice\n\n    dat2 <- source_data[[\"pht003094\"]]\n    dat2 <- dat2[dat2$idtype %in% 2, ] # choose NOS\n    vars <- paste0(\"g3b0\", 625:630)\n    nm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\", \"No\")\n    for (i in 1:length(vars)){\n      dat2[, vars[i]] <- as.integer(dat2[, vars[i]])\n      names(dat2)[names(dat2) %in% vars[i]] <- nm[i]\n    }\n   w <- which(is.element(dat2, \".\"))\n   dat2[w] <- NA\n   dat2$race_us <- NA\n\n   cnm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\")\n   dat2$rs <- rowSums(dat2[, cnm], na.rm = TRUE)\n\n  # if only one category chosen, assign that category as the race\n   s1 <- dat2$rs %in% 1 & !(dat2$No %in% 1)\n   ws1 <- which(s1)\n   t2 <- dat2[s1, cnm]\n   wa <- which(t2 == 1, arr.ind = T)\n   dat2$race_us[ws1[wa[, 1]]] <- cnm[wa[, 2]]\n\n # if more than one race category chosen, assign race_us as \"Multiple\"\n   s3 <- dat2$rs > 1 & !(dat2$No %in% 1)\n   dat2$race_us[s3] <- \"Multiple\"\n\n  # no other race chosen but indicated Hispanic ethnicity, set race_us to Other\n   s <- dat2$g3b0624 %in% 1 & dat2$rs %in% 0\n   dat2$race_us[s] <- \"Other\"\n\n   dat2$race_us[dat2$No %in% 1] <- NA\n\n   dat2 <- dat2 %>% filter(!is.na(dat2$race_us)) %>% select(topmed_subject_id, race_us)\n\n # check for consistency across visits - if differ, assign race_us as \"Multiple\"\n   dat <- rbind(dat1, dat2)\n\n   dat <- dat %>% tbl_df() %>%\n       arrange(topmed_subject_id) %>%\n        group_by(topmed_subject_id)\n\n    # determine number of unique race categories chosen across visits for each subject\n sdat <- dat %>% summarise(ncatr = length(unique(race_us)), ot = is.element(\"Other\", race_us))\n\n   # if more than one race category (not including \"Other\") per subject across visits,\n   #   assign race_us = Multiple\n\n   datt <- inner_join(dat, sdat)\n   selr <- datt$ncatr > 2\n   datt$race_us[selr] <- \"Multiple\"\n\n   so <- datt$ncatr == 2 & datt$ot == FALSE\n   datt$race_us[so] <- \"Multiple\"\n\n  # if race chosen as Other and one other race also chosen, assign the more specific race\n   se <- datt$ncatr == 2 & datt$ot == TRUE\n   sse <- se & datt$race_us %in% \"Other\"\n   datt <- datt[!sse, ]\n   ## take out the \"Other\" entry so slice(1) (taking first entry per subject)\n   #   will capture the more specific race\n\n   datt <- datt %>% filter(!is.na(race_us)) %>% slice(1) %>%\n           select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "FHS_Offspring",
      "component_study_variables": ["phs000007.v30.pht000747.v6.phv00072044.v5", "phs000007.v30.pht000747.v6.phv00072530.v5", "phs000007.v30.pht000747.v6.phv00072531.v5", "phs000007.v30.pht000747.v6.phv00072532.v5", "phs000007.v30.pht000747.v6.phv00072533.v5", "phs000007.v30.pht000747.v6.phv00072534.v5", "phs000007.v30.pht000747.v6.phv00072537.v5"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us and hispanic_or_latino for FHS Offspring\n # variables are 0/1 (no/yes) for given categories\n # White (Caucasian or White)\n # Black (African-American or Black), Asian, HI_PI (Native Hawaiian or Pacific Islander\n # AI_AN (American Indian or Alaskan Native),  No (Prefer not to answer)\n # can choose more than one\n # ethnicity questions are separate\n\n   source_data <- phen_list$source_data\n\n   # visit 8 data\n\n    dat1 <- source_data[[\"pht000747\"]]\n    dat1 <- dat1[dat1$IDTYPE %in% 1, ]\n    vars <- paste0(\"H\", 702:707)\n    nm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\", \"No\")\n\n    #  rename variables; change 0/1 categorical to integer\n    for (i in 1:length(vars)){\n      dat1[, vars[i]] <- as.integer(dat1[, vars[i]])\n      names(dat1)[names(dat1) %in% vars[i]] <- nm[i]\n    }\n   w <- which(is.element(dat1, \".\"))\n   dat1[w] <- NA\n   dat1$race_us <- NA\n\n   cnm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\")\n\n  # add up 0's and 1's across variables for each subject\n  # if sum =1 only chose one race category, if sum > 1 chose multiple race categories,\n  #  if sum = 0, did not choose any of the indicated categories\n   dat1$rs <- rowSums(dat1[, cnm], na.rm = TRUE)\n\n  # if only one category chosen, assign that category as the race\n   s1 <- dat1$rs %in% 1 & !(dat1$No %in% 1)\n   ws1 <- which(s1)\n   t2 <- dat1[s1, cnm]\n   wa <- which(t2 == 1, arr.ind = T)\n   dat1$race_us[ws1[wa[, 1]]] <- cnm[wa[, 2]]\n\n # if more than one race category chosen, assign race_us as \"Multiple\"\n   s3 <- dat1$rs > 1 & !(dat1$No %in% 1)\n   dat1$race_us[s3] <- \"Multiple\"\n   dat1$race_us[dat1$No %in% 1] <- NA\n\n   datt <- dat1 %>% filter(!is.na(dat1$race_us)) %>% select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "FHS_Omni1",
      "component_study_variables": ["phs000007.v30.pht004815.v1.phv00251263.v1", "phs000007.v30.pht004815.v1.phv00251748.v1", "phs000007.v30.pht004815.v1.phv00251749.v1", "phs000007.v30.pht004815.v1.phv00251750.v1", "phs000007.v30.pht004815.v1.phv00251751.v1", "phs000007.v30.pht004815.v1.phv00251752.v1", "phs000007.v30.pht004815.v1.phv00251753.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us and hispanic_or_latino for FHS Omni1\n # variables are 0/1 (no/yes) for given categories\n # White (Caucasian or White)\n # Black (African-American or Black), Asian, HI_PI (Native Hawaiian or Pacific Islander\n # AI_AN (American Indian or Alaskan Native),  No (Prefer not to answer)\n # can choose more than one\n # ethnicity questions are separate\n\n   source_data <- phen_list$source_data\n\n   # visit 3 data\n\n    dat1 <- source_data[[\"pht004815\"]]\n    dat1 <- dat1[dat1$idtype %in% 7, ]\n    vars <- paste0(\"h\", 702:707)\n    nm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\", \"No\")\n\n  #  rename variables; change 0/1 categorical to integer\n    for (i in 1:length(vars)){\n      dat1[, vars[i]] <- as.integer(dat1[, vars[i]])\n      names(dat1)[names(dat1) %in% vars[i]] <- nm[i]\n    }\n   w <- which(is.element(dat1, \".\"))\n   dat1[w] <- NA\n   dat1$race_us <- NA\n\n   cnm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\")\n\n  # add up 0's and 1's across variables for each subject\n  # if sum =1 only chose one race category, if sum > 1 chose multiple race categories,\n  #  if sum = 0, did not choose any of the indicated categories\n   dat1$rs <- rowSums(dat1[, cnm], na.rm = TRUE)\n\n  # if only one category chosen, assign that category as the race\n   s1 <- dat1$rs %in% 1 & !(dat1$No %in% 1)\n   ws1 <- which(s1)\n   t2 <- dat1[s1, cnm]\n   wa <- which(t2 == 1, arr.ind = T)\n   dat1$race_us[ws1[wa[, 1]]] <- cnm[wa[, 2]]\n\n # if more than one race category chosen, assign race_us as \"Multiple\"\n   s3 <- dat1$rs > 1 & !(dat1$No %in% 1)\n   dat1$race_us[s3] <- \"Multiple\"\n\n   dat1$race_us[dat1$No %in% 1] <- NA\n\n   datt <- dat1 %>% filter(!is.na(dat1$race_us)) %>% select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "FHS_Omni2",
      "component_study_variables": ["phs000007.v30.pht003094.v5.phv00177238.v3", "phs000007.v30.pht003094.v5.phv00177597.v3", "phs000007.v30.pht003094.v5.phv00177598.v3", "phs000007.v30.pht003094.v5.phv00177599.v3", "phs000007.v30.pht003094.v5.phv00177600.v3", "phs000007.v30.pht003094.v5.phv00177601.v3", "phs000007.v30.pht003094.v5.phv00177602.v3", "phs000007.v30.pht003094.v5.phv00177603.v3", "phs000007.v30.pht006006.v2.phv00274194.v2", "phs000007.v30.pht006006.v2.phv00274557.v2", "phs000007.v30.pht006006.v2.phv00274558.v2", "phs000007.v30.pht006006.v2.phv00274559.v2", "phs000007.v30.pht006006.v2.phv00274560.v2", "phs000007.v30.pht006006.v2.phv00274561.v2", "phs000007.v30.pht006006.v2.phv00274562.v2", "phs000007.v30.pht006006.v2.phv00274563.v2", "phs000007.v30.pht006006.v2.phv00274564.v2"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us and hispanic_or_latino for FHS Omni2\n # variables are 0/1 (no/yes) for given categories\n # White (Caucasian or White), Hispanic (Spanish/Hispanic/Latino)\n # Black (African-American or Black), Asian, HI_PI (Native Hawaiian or Pacific Islander\n # AI_AN (American Indian or Alaskan Native), Other, No (Prefer not to answer)\n # can choose more than one\n\n   source_data <- phen_list$source_data\n\n   # visit 1 data\n\n    dat1 <- source_data[[\"pht006006\"]]\n    dat1 <- dat1[dat1$idtype %in% 72, ]\n    vars <- paste0(\"g3a\", 483:490)\n\n  #  rename variables; change 0/1 categorical to integer\n    nm <- c(\"White\", \"Hispanic\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\", \"Other\", \"No\")\n    for (i in 1:length(vars)){\n      dat1[, vars[i]] <- as.integer(dat1[, vars[i]])\n      names(dat1)[names(dat1) %in% vars[i]] <- nm[i]\n    }\n   w <- which(is.element(dat1, \".\"))\n   dat1[w] <- NA\n   dat1$race_us <- NA\n\n  # treat \"Hispanic\" differently\n   cnm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\", \"Other\")\n\n  # add up 0's and 1's across variables for each subject\n  # if sum =1 only chose one race category, if sum > 1 chose multiple race categories,\n  #   if sum = 0, did not choose any of the indicated categories\n   dat1$rs <- rowSums(dat1[, cnm], na.rm = TRUE)\n\n  # if only one category chosen, assign that category as the race\n   s1 <- dat1$rs %in% 1 & !(dat1$No %in% 1)\n   ws1 <- which(s1)\n   t2 <- dat1[s1, cnm]\n   wa <- which(t2 == 1, arr.ind = T)\n   dat1$race_us[ws1[wa[, 1]]] <- cnm[wa[, 2]]\n\n # if more than one race category chosen, assign race_us as \"Multiple\"\n   s3 <- dat1$rs > 1 & !(dat1$No %in% 1)\n   dat1$race_us[s3] <- \"Multiple\"\n\n # if Hispanic category chosen with no other race category, assign \"Other\"\n # person did choose to identify a race\n # ethnicity will be set to 1 (i.e. is Hispanic)\n\n   s <- dat1$Hispanic %in% 1 & dat1$rs %in% 0\n   dat1$race_us[s] <- \"Other\"\n\n   dat1$race_us[dat1$No %in% 1] <- NA\n\n   dat1 <- dat1 %>% filter(!is.na(dat1$race_us)) %>% select(topmed_subject_id, race_us)\n\n   # visit 2 data - contains Gen3, NOS, Omni2\n   # Hispanic is not race choice but there is question re Hispanic ethnicity;\n#     set race_us to Other if no other race choice\n\n    dat2 <- source_data[[\"pht003094\"]]\n    dat2 <- dat2[dat2$idtype %in% 72, ] # choose Omni2\n    vars <- paste0(\"g3b0\", 625:630)\n    nm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\", \"No\")\n    for (i in 1:length(vars)){\n      dat2[, vars[i]] <- as.integer(dat2[, vars[i]])\n      names(dat2)[names(dat2) %in% vars[i]] <- nm[i]\n    }\n   w <- which(is.element(dat2, \".\"))\n   dat2[w] <- NA\n   dat2$race_us <- NA\n\n   cnm <- c(\"White\", \"Black\", \"Asian\", \"HI_PI\", \"AI_AN\")\n   dat2$rs <- rowSums(dat2[, cnm], na.rm = TRUE)\n\n  # if only one category chosen, assign that category as the race\n   s1 <- dat2$rs %in% 1 & !(dat2$No %in% 1)\n   ws1 <- which(s1)\n   t2 <- dat2[s1, cnm]\n   wa <- which(t2 == 1, arr.ind = T)\n   dat2$race_us[ws1[wa[, 1]]] <- cnm[wa[, 2]]\n\n # if more than one race category chosen, assign race_us as \"Multiple\"\n   s3 <- dat2$rs > 1 & !(dat2$No %in% 1)\n   dat2$race_us[s3] <- \"Multiple\"\n\n  # no other race chosen but indicated Hispanic ethnicity, set race_us to Other\n   s <- dat2$g3b0624 %in% 1 & dat2$rs %in% 0\n   dat2$race_us[s] <- \"Other\"\n\n   dat2$race_us[dat2$No %in% 1] <- NA\n\n   dat2 <- dat2 %>% filter(!is.na(dat2$race_us)) %>% select(topmed_subject_id, race_us)\n\n # check for consistency across visits - if differ, assign race_us as \"Multiple\"\n   dat <- rbind(dat1, dat2)\n\n   dat <- dat %>% tbl_df() %>%\n       arrange(topmed_subject_id) %>%\n        group_by(topmed_subject_id)\n\n    # determine number of unique race categories chosen across visits for each subject\n   sdat <- dat %>% summarise(ncatr = length(unique(race_us)), ot = is.element(\"Other\", race_us))\n\n   # if more than one race category (not including \"Other\") per subject across visits,\n#     assign race_us = Multiple\n   datt <- inner_join(dat, sdat)\n   selr <- datt$ncatr > 2\n   datt$race_us[selr] <- \"Multiple\"\n\n   so <- datt$ncatr == 2 & datt$ot == FALSE\n   datt$race_us[so] <- \"Multiple\"\n\n  # if race chosen as Other and one other race also chosen, assign the more specific race\n   se <- datt$ncatr == 2 & datt$ot == TRUE\n   sse <- se & datt$race_us %in% \"Other\"\n   datt <- datt[!sse, ]\n  # take out the \"Other\" entry so slice(1) (taking first entry per subject)\n  #   will capture the more specific race\n\n   datt <- datt %>% filter(!is.na(race_us)) %>% slice(1) %>%\n          select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "FHS_Original",
      "component_study_variables": ["phs000007.v30.pht003099.v5.phv00177928.v5"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us for Original cohort\n # Nancy Heard-Costa confirmed can assume White\n # use global information file to get subjects\n\n   source_data <- phen_list$source_data\n\n    dat <- source_data[[\"pht003099\"]]\n    w <- which(is.element(dat, \".\"))\n    dat[w] <- NA\n\n    dat <- dat[dat$idtype %in% 0, ]\n    dat$race_us <- \"White\"\n\n    datt <- dat %>% select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "GALAII",
      "component_study_variables": ["phs001180.v1.pht006988.v1.phv00320615.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n  library(dplyr)\n\n  dataset <- phen_list$source_data$pht006988 %>%\n    # Filter out unconsented individuals.\n    filter(!(CONSENT %in% \"0\") & !is.na(CONSENT)) %>%\n    # Create race_us variable\n    # Confirmed with study, race_us = Other\n    transmute(topmed_subject_id, race_us = \"Other\")\n\n  return(dataset)\n}\n"
    },
    {
      "name": "GeneSTAR",
      "component_study_variables": ["phs001218.v1.pht007766.v1.phv00369267.v1", "phs001218.v1.pht007766.v1.phv00369270.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n  library(dplyr)\n\n  #Datasets\n  int <- phen_list$source_data$pht007766\n  #Order of levels\n  int$VISIT <- int$VISIT %>%\n               as.factor() %>%\n               relevel('SSV')\n  #Subset to baseline visits, SSV and PSV\n  dataset <- int %>%\n             filter(VISIT %in% c('SSV', 'PSV')) %>%\n             mutate(VISIT = as.factor(VISIT)) %>%\n             group_by(topmed_subject_id) %>%\n             arrange(topmed_subject_id, VISIT) %>%\n             filter(row_number(topmed_subject_id) == 1) %>%\n             ungroup() %>%\n             data.frame()\n\n  #Assigning race_us categories\n  dataset$RACE <- ifelse(dataset$RACE == '1', 'White', 'Black')\n\n  #Rename harmonized variable\n  dataset <- select(dataset, topmed_subject_id, race_us = RACE)\n\n  return(dataset)\n}\n"
    },
    {
      "name": "GENOA",
      "component_study_variables": ["phs001238.v2.pht006039.v1.phv00277509.v1", "phs001238.v2.pht006653.v1.phv00307790.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us for GENOA\n    source_data <- phen_list$source_data\n\n# values are \"African-American\", \"Hispanic White\", \"Non-Hispanic White\"\n\n   dat1 <- source_data[[\"pht006039\"]]   # AA sub-study\n   dat2 <- source_data[[\"pht006653\"]]   # EA sub_study\n   dat <- rbind(dat1, dat2)\n\n# filter to non-missing values\n# assign Black = African-American, White = either of the other two values\n# select subject id and race_us\n   dat <- dat %>% filter(!is.na(RACE)) %>%\n           mutate(race_us = ifelse(RACE %in% \"African-American\", \"Black\", \"White\")) %>%\n           select(topmed_subject_id, race_us)\n\n   return(dat)\n}\n"
    },
    {
      "name": "GOLDN",
      "component_study_variables": ["phs000741.v2.pht003915.v2.phv00202090.v2"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n    source_data <- phen_list$source_data\n    dat <- source_data[[\"pht003915\"]]\n\n  # GOLDN dbGaP study page says \"recruited Caucasian\" so set race_us = \"White\"\n  # pull in subject file and eliminate consent=0 subjects\n\n   dat <- dat %>% filter(!is.element(consent, 0)) %>%\n        mutate(race_us = \"White\") %>%\n        select(topmed_subject_id, race_us)\n\n   return(dat)\n}\n"
    },
    {
      "name": "HCHS_SOL",
      "component_study_variables": ["phs000810.v1.pht004713.v1.phv00226241.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n    source_data <- phen_list$source_data\n    dat <- source_data[[\"pht004713\"]]\n\n  # All subjects are Hispanic/Latino\n  # set race_us to Other and ethnicity to HL\n  # will define ethnic_subgroup variable\n  # pull in subject file and eliminate consent=0 subjects\n\n   dat <- dat %>% filter(!is.element(CONSENT, 0)) %>%\n        mutate(race_us = \"Other\") %>%\n        select(topmed_subject_id, race_us)\n\n      return(dat)\n}\n"
    },
    {
      "name": "HVH",
      "component_study_variables": ["phs001013.v3.pht005311.v2.phv00259380.v2"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n  library(dplyr)\n  dat <- phen_list$source_data$pht005311 %>%\n    # Remove rows where race is missing or unknown.\n    filter(!is.na(race) & !(race %in% 9)) %>%\n    group_by(topmed_subject_id) %>%\n    # Collapse race by topmed_subject_id.\n    summarize(race = unique(race))\n\n  rc <- c(\"Black\", \"White\", \"Asian\", \"AI_AN\", \"HI_PI\", \"Other\")\n  dat$race <- as.integer(dat$race) + 1\n  dat$race <- rc[dat$race]\n\n  dat <- select(dat, topmed_subject_id, race_us = race)\n  return(dat)\n}\n"
    },
    {
      "name": "JHS",
      "component_study_variables": ["phs000286.v5.pht001920.v4.phv00124546.v3"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n    source_data <- phen_list$source_data\n    dat <- source_data[[\"pht001920\"]]\n\n  # confirmed with PI that all subjects are African American so set race_us=\"Black\"\n  # pull in subject file and eliminate consent=0 subjects\n\n   dat <- dat %>% filter(!is.element(CONSENT, 0)) %>%\n        mutate(race_us = \"Black\") %>%\n        select(topmed_subject_id, race_us)\n\n   return(dat)\n\n}\n"
    },
    {
      "name": "Mayo_VTE_GENEVA",
      "component_study_variables": ["phs000289.v2.pht001886.v2.phv00121876.v2", "phs000289.v2.pht001886.v2.phv00121877.v2", "phs000289.v2.pht001886.v2.phv00121878.v2", "phs000289.v2.pht001886.v2.phv00121879.v2", "phs000289.v2.pht001886.v2.phv00121880.v2", "phs000289.v2.pht001886.v2.phv00121881.v2"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n\n# harmonize race_us for Mayo_VTE\n  datt <- phen_list$source_data[[\"pht001886\"]]\n\n  rc <- c(\"race_other\", \"race_afram\", \"race_amind\", \"race_asian\", \"race_pacisl\", \"race_white\")\n # variables are 1 if category chosen, otherwise 0\n\n # convert to integer\n # change category names to harmonized names\n hnm <- c(\"Other\", \"Black\", \"AI_AN\", \"Asian\", \"HI_PI\", \"White\")\n  for (i in 1:6){\n    datt[, rc[i]] <- as.integer(datt[, rc[i]])\n    names(datt)[names(datt) %in% rc[i]] <- hnm[i]\n  }\n\n # rowSums in effect counts the number of categories chosen\n  datt$rs <- rowSums(datt[, hnm], na.rm = T)\n\n  datt$race_us <- NA\n # if rs=0, no categories were chosen; keep race_us as NA\n # if rs=1 then only one category chosen so assign race_us = that category\n   s1 <- datt$rs %in% 1\n   ws1 <- which(s1)\n   t2 <- datt[s1, hnm]\n   wa <- which(t2 == 1, arr.ind = TRUE)\n # wa[,1] gives row (subject index), wa[,2] gives column index of column/category chosen\n   datt$race_us[ws1[wa[, 1]]] <- hnm[wa[, 2]]\n\n # if rs > 1 multiple categories chosen so assign race_us = \"Multiple\"\n   datt$race_us[datt$rs > 1] <- \"Multiple\"\n\n   datt <- datt %>% filter(!is.na(datt$race_us)) %>% select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "Mayo_VTE_Olmsted",
      "component_study_variables": ["phs001402.v1.pht008239.v1.phv00389932.v1", "phs001402.v1.pht008239.v1.phv00389933.v1", "phs001402.v1.pht008239.v1.phv00389934.v1", "phs001402.v1.pht008239.v1.phv00389935.v1", "phs001402.v1.pht008239.v1.phv00389936.v1", "phs001402.v1.pht008239.v1.phv00389937.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n  library(dplyr)\n\n  dataset <- phen_list$source_data$pht008239\n\n  #Assiging race\n  dataset$race_us[dataset$race_white == 1] <- 'White'\n  dataset$race_us[dataset$race_other == 1] <- 'Other'\n  dataset$race_us[dataset$race_afram == 1] <- 'Black'\n  dataset$race_us[dataset$race_amind == 1] <- 'AI_AN'\n  dataset$race_us[dataset$race_asian == 1] <- 'Asian'\n\n  dataset <- dataset %>%\n             select(topmed_subject_id, race_us) %>%\n             return()\n}\n"
    },
    {
      "name": "MESA_AirNR",
      "component_study_variables": ["phs000209.v13.pht001111.v4.phv00082641.v1", "phs000209.v13.pht003086.v3.phv00174585.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us and hispanic_or_latino for MESA AirNR\n # 1=white; 2=chinese american; 3=black;4=hispanic\n\n    source_data <- phen_list$source_data\n\n   # visit 1 data\n   dat1 <- source_data[[\"pht001111\"]]\n\n   # visit 5 data\n    dat5 <- source_data[[\"pht003086\"]]\n\n   dat <- rbind(dat1, dat5)\n\n   dat$race_us <- dat$race1c\n   dat$race_us[dat$race_us %in% 1] <- \"White\"\n   dat$race_us[dat$race_us %in% 2] <- \"Asian\"\n   dat$race_us[dat$race_us %in% 3] <- \"Black\"\n   dat$race_us[dat$race_us %in% 4] <- \"Other\"  # will set ethnicity = HL\n\n   dat <- dat %>% filter(!is.na(race_us)) %>% tbl_df() %>%\n     arrange(topmed_subject_id) %>%\n       group_by(topmed_subject_id)\n\n    # determine number of unique race categories chosen across visits for each subject\n   sdat <- dat %>% summarise(ncatr = length(unique(race_us)), ot = is.element(\"Other\", race_us))\n\n   # if more than one race category (not including \"Other\") per subject across visits,\n   #   assign race_us = Multiple\n   datt <- inner_join(dat, sdat)\n   selr <- datt$ncatr > 2\n   datt$race_us[selr] <- \"Multiple\"\n\n   so <- datt$ncatr == 2 & datt$ot == FALSE\n   datt$race_us[so] <- \"Multiple\"\n\n  # if race chosen as Hispanic/Other and one other race also chosen, assign that one other race\n   se <- datt$ncatr == 2 & datt$ot == TRUE\n   sse <- se & datt$race_us %in% \"Other\"\n   datt <- datt[!sse, ]\n  #  take out the \"Other\" entry so slice(1) (taking first entry per subject)\n#     will capture the more specific race\n   datt <- datt %>% filter(!is.na(race_us)) %>% slice(1) %>%\n      select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "MESA_Classic",
      "component_study_variables": ["phs000209.v13.pht001116.v10.phv00084444.v2", "phs000209.v13.pht001118.v8.phv00085775.v2", "phs000209.v13.pht001119.v8.phv00086261.v2", "phs000209.v13.pht001120.v10.phv00086729.v2", "phs000209.v13.pht003091.v3.phv00176008.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us and hispanic_or_latino for MESA Classic\n # 1=white; 2=chinese american; 3=black;4=hispanic\n\n   source_data <- phen_list$source_data\n\n   # visit 1 data\n    dat1 <- source_data[[\"pht001116\"]]\n\n   # visit 2 data\n    dat2 <- source_data[[\"pht001118\"]]\n\n   # visit 3 data\n    dat3 <- source_data[[\"pht001119\"]]\n\n   # visit 4 data\n   dat4 <- source_data[[\"pht001120\"]]\n\n   # visit 5 data\n    dat5 <- source_data[[\"pht003091\"]]\n\n   dat0 <- rbind(dat1, dat2, dat3, dat4, dat5)\n\n   dat0$race_us <- dat0$race1c\n   dat0$race_us[dat0$race_us %in% 1] <- \"White\"\n   dat0$race_us[dat0$race_us %in% 2] <- \"Asian\"\n   dat0$race_us[dat0$race_us %in% 3] <- \"Black\"\n   dat0$race_us[dat0$race_us %in% 4] <- \"Other\"   # will set ethnicity = \"HL\"\n\n   dat0 <- dat0 %>% tbl_df()  %>%\n       arrange(topmed_subject_id) %>%\n        group_by(topmed_subject_id)\n\n   dat <- dat0 %>% filter(!is.na(race_us))\n\n    # determine number of unique race categories chosen across visits for each subject\n   sdat <- dat %>% summarise(ncatr = length(unique(race_us)), ot = is.element(\"Other\", race_us))\n\n   # if more than one race category (not including \"Other\") per subject across visits,\n#      assign race = Multiple\n   datt <- inner_join(dat, sdat)\n   selr <- datt$ncatr > 2\n   datt$race_us[selr] <- \"Multiple\"\n\n   so <- datt$ncatr == 2 & datt$ot == FALSE\n   datt$race_us[so] <- \"Multiple\"\n\n  # if race chosen as Hispanic and one other race also chosen, assign the more specific race\n   se <- datt$ncatr == 2 & datt$ot == TRUE\n   sse <- se & datt$race_us %in% \"Other\"\n   datt <- datt[!sse, ]\n  # take out the \"Other\" entry so slice(1) (taking first entry per subject)\n#    will capture the more specific race\n\n   datt <- datt %>% filter(!is.na(race_us)) %>% slice(1) %>%\n          select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "MESA_Family",
      "component_study_variables": ["phs000209.v13.pht001121.v3.phv00087074.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us and hispanic_or_latino for MESA Family\n # 1=white; 2=chinese american; 3=black;4=hispanic\n\n    source_data <- phen_list$source_data\n\n   # visit 1 data\n    dat <- source_data[[\"pht001121\"]]\n\n   dat$race_us <- dat$racefc\n   dat$race_us[dat$race_us %in% 1] <- \"White\"\n   dat$race_us[dat$race_us %in% 2] <- \"Asian\"\n   dat$race_us[dat$race_us %in% 3] <- \"Black\"\n   dat$race_us[dat$race_us %in% 4] <- \"Other\"  # will set ethnicity = HL\n\n   datt <- dat %>% filter(!is.na(race_us)) %>%\n          select(topmed_subject_id, race_us)\n\n   return(datt)\n}\n"
    },
    {
      "name": "MGH_AF",
      "component_study_variables": ["phs001001.v1.pht005655.v1.phv00265713.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n\n  library(dplyr)\n\n  dataset <- phen_list$source_data$pht005655\n\n  dataset$race_cat <- ifelse(dataset$race == 'african_american', 'Black',\n    ifelse(dataset$race == 'asian', 'Asian',\n      ifelse(dataset$race == 'white', 'White',\n        ifelse(dataset$race == 'american_indian', 'AI_AN',\n          ifelse(dataset$race == 'other', 'Other',\n            ifelse(dataset$race == 'american_indian_black', 'Multiple',\n              ifelse(dataset$race == 'pacific_islanders', 'HI_PI', NA)))))))\n\n  dataset <- select(dataset, topmed_subject_id, race_us = race_cat)\n\n  return(dataset)\n}\n"
    },
    {
      "name": "Partners",
      "component_study_variables": ["phs001024.v3.pht005693.v1.phv00265980.v1"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n  library(dplyr)\n\n  #Dataset\n  dataset <- phen_list$source_data$pht005693\n\n  #Race categories\n  dataset$race_cat <- ifelse(dataset$race == 'white', 'White',\n                             ifelse(dataset$race == 'black', 'Black',\n                                    ifelse(dataset$race == 'asian', 'Asian',\n                                           ifelse(dataset$race == 'hispanic', 'Other',\n                                                  ifelse(dataset$race == 'other', 'Other', NA)))))\n\n  #Variable selection and remove missing\n  dataset <- select(dataset, topmed_subject_id, race_us = race_cat) %>%\n             na.omit()\n\n  return(dataset)\n}\n"
    },
    {
      "name": "SAGE",
      "component_study_variables": ["phs000921.v3.pht004883.v3.phv00252285.v3"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list) {\n  #Dataset\n  dataset <- phen_list$source_data$pht004883 %>%\n             rename(race_us = RACE)\n\n  #Relevel variable\n  dataset$race_us <- as.factor(dataset$race_us)\n  levels(dataset$race_us) <- c('Black', 'Multiple', 'Multiple', 'Multiple', 'Multiple', 'Multiple')\n\n  return(dataset)\n}\n"
    },
    {
      "name": "VAFAR",
      "component_study_variables": ["phs000997.v3.pht005688.v3.phv00265924.v3"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n  library(dplyr)\n\n  # Get dataset.\n  dataset <- phen_list$source_data$pht005688 %>%\n             rename(race_us = race)\n\n  # Substitute encoded race values.\n  dataset$race_us[dataset$race_us %in% 'white'] <- 'White'\n\n  # Substitute the value of 'NA' to missing.\n  dataset$race_us[dataset$race_us %in% 'NA'] <- NA\n\n  # Remove records with NAs from dataset.\n  dataset <- na.omit(dataset)\n\n  return(dataset)\n}\n"
    },
    {
      "name": "VU_AF",
      "component_study_variables": ["phs001032.v4.pht005675.v3.phv00265808.v2"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n  library(dplyr)\n\n  # Get dataset.\n  dataset <- phen_list$source_data$pht005675 %>%\n             rename(race_us = race)\n\n  # Substitute encoded race values.\n  dataset$race_us[dataset$race_us %in% 'white'] <- 'White'\n  dataset$race_us[dataset$race_us %in% 'black'] <- 'Black'\n  dataset$race_us[dataset$race_us %in% 'asian'] <- 'Asian'\n  dataset$race_us[dataset$race_us %in% 'native_american'] <- 'AI_AN'\n\n  # Substitute the value of 'NA' to missing.\n  dataset$race_us[dataset$race_us %in% 'NA'] <- NA\n\n  # Remove records with NAs from dataset.\n  dataset <- na.omit(dataset)\n\n  return(dataset)\n}\n"
    },
    {
      "name": "WGHS",
      "component_study_variables": ["phs001040.v3.pht005682.v3.phv00328556.v2"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n\n  #Dataset and rename race variable\n  dataset <- phen_list$source_data$pht005682 %>%\n             rename(race_us = race)\n\n  #Rename variable category\n  dataset$race_us <- 'White'\n\n  return(dataset)\n}\n"
    },
    {
      "name": "WHI",
      "component_study_variables": ["phs000200.v11.pht000998.v6.phv00078450.v6", "phs000200.v11.pht001009.v6.phv00079317.v6", "phs000200.v11.pht001009.v6.phv00079318.v6", "phs000200.v11.pht001009.v6.phv00079319.v6", "phs000200.v11.pht001009.v6.phv00079320.v6", "phs000200.v11.pht001009.v6.phv00079321.v6", "phs000200.v11.pht001009.v6.phv00079322.v6", "phs000200.v11.pht001009.v6.phv00079323.v6", "phs000200.v11.pht001009.v6.phv00079324.v6", "phs000200.v11.pht001009.v6.phv00079325.v6", "phs000200.v11.pht001009.v6.phv00079326.v6", "phs000200.v11.pht001009.v6.phv00079327.v6", "phs000200.v11.pht001009.v6.phv00079328.v6", "phs000200.v11.pht001009.v6.phv00079329.v6", "phs000200.v11.pht001009.v6.phv00079330.v6", "phs000200.v11.pht001009.v6.phv00079331.v6"],
      "component_harmonized_variables": [],
      "harmonization_function": "harmonize <- function(phen_list){\n    library(dplyr)\n    library(magrittr)\n\n # harmonize race_us for WHI\n # From WHI study investigator: Form 2 takes precedence, Form 41 can be used for more specificity\n #  Form 2 Asian or Pacific Islander category:\n #    can use Form 41 to identify Pacific Islander, assign rest Asian\n # all subjects were present for Form 2\n\n    source_data <- phen_list$source_data\n\n ## baseline Form 2\n # 1=American Indian or Alaskan Native; 2=Asian or Pacific Islander; 3=Black or African American;\n # 4=Hispanic/Latino; 5=White (not of Hispanic origin); 8 = Other\n\n   dat1 <- source_data[[\"pht000998\"]]\n\n   dat1$RACE[dat1$RACE %in% 8] <- 6\n   dat1$RACE <- as.integer(dat1$RACE)\n   rc <- c(\"AI_AN\", \"AsPacIsl\", \"Black\", \"Hispanic\", \"White\", \"Other\")\n   dat1$RACE <- rc[dat1$RACE]\n\n ## additional race information Form 41\n # variable SPANISH: 0 = not Hispanic, 1 = Puerto Rican, 2 = Mexican/MexicanAmerican, Chicano\n #  3 = Cuban, 4 = Other Hispanic\n # SPANISH: use for ethnicity and ethnic_subgroup variables\n # other variables are 0/1 for No/Yes for a given race category\n\n   dat2 <- source_data[[\"pht001009\"]]\n\n  asian <- c(\"CHINESE\", \"JAPANESE\", \"KOREAN\", \"ASIAINDIAN\", \"OTHERASIAN\", \"VIETNAMESE\", \"FILIPINO\")\n  pacisl <- c(\"GUAMANIAN\", \"HAWAIIAN\", \"OTHRPACISL\", \"SAMOAN\")\n  rest <- c(\"WHITE\", \"BLACK\", \"AMERINDIAN\", \"OTHERRACE\")\n  rest2 <- c(\"White\", \"Black\", \"AI_AN\", \"Other\")\n  for (i in 1:length(rest)){\n       names(dat2)[names(dat2) %in% rest[i]] <- rest2[i]\n  }\n\n  asel1 <- FALSE\n  asel0 <- TRUE\n  for (i in 1:length(asian)){\n    asel1 <- asel1 | dat2[, asian[i]] %in% 1\n    asel0 <- asel0 & dat2[, asian[i]] %in% 0\n  }\n  dat2$asian <- NA\n  dat2$asian[asel1] <- 1\n  dat2$asian[asel0] <- 0\n\n  asel1 <- FALSE\n  asel0 <- TRUE\n  for (i in 1:length(pacisl)){\n    asel1 <- asel1 | dat2[, pacisl[i]] %in% 1\n    asel0 <- asel0 & dat2[, pacisl[i]] %in% 0\n  }\n  dat2$pacisl <- NA\n  dat2$pacisl[asel1] <- 1\n  dat2$pacisl[asel0] <- 0\n\n  cnm <- c(rest2, \"asian\", \"pacisl\")\n  for (cn in cnm){\n    dat2[, cn] <- as.integer(dat2[, cn])\n  }\n\n  dat2$rs <- rowSums(dat2[, cnm], na.rm = TRUE)\n\n  dat2$race2 <- NA\n\n # if only one category chosen, assign that category as the race\n   s1 <- dat2$rs %in% 1\n   ws1 <- which(s1)\n   t2 <- dat2[s1, cnm]\n   wa <- which(t2 == 1, arr.ind = TRUE)\n   dat2$race2[ws1[wa[, 1]]] <- cnm[wa[, 2]]\n\n   dat2$race2[dat2$race2 %in% \"asian\"] <- \"Asian\"\n   dat2$race2[dat2$race2 %in% \"pacisl\"] <- \"HI_PI\"\n\n   dat3 <- dat2 %>% select(topmed_subject_id, race2)\n\n ## combine to assess more specificity\n ## Form 2 takes precedence even if inconsistency\n\n   datt <- full_join(dat1, dat3)\n\n   datt$race_us <- NA\n\n #--- AsPacIsl: assign Asian unless there is more specific information\n#   to determine Hawaiian or Pacific Islander---\n   x <- datt$RACE %in% \"AsPacIsl\"\n\n   ps <- datt$race2 %in% \"HI_PI\"\n   sel <- x & ps\n   datt$race_us[sel] <- \"HI_PI\"\n\n   n <- x & !sel\n   datt$race_us[n] <- \"Asian\"\n\n #--- Hispanic ---\n   x <- datt$RACE %in% \"Hispanic\"\n  datt$race_us[x] <- datt$race2[x]\n\n  s3 <- x & is.na(datt$race2)\n  datt$race_us[s3] <- \"Other\"\n\n #--- Other ---\n  x <- datt$RACE %in% \"Other\"\n  s1 <- x & !is.na(datt$race2)\n  datt$race_us[s1] <- datt$race2[s1]\n  s2 <- x & is.na(datt$race2)\n  datt$race_us[s2] <- \"Other\"\n\n #--- White ---\n  x <- datt$RACE %in% \"White\"\n  datt$race_us[x] <- \"White\"\n\n #--- Black ---\n  x <- datt$RACE %in% \"Black\"\n  datt$race_us[x] <- \"Black\"\n\n #--- AI_AN ---\n  x <- datt$RACE %in% \"AI_AN\"\n  datt$race_us[x] <- \"AI_AN\"\n\n #--- Unspecified ---\n  x <- is.na(datt$RACE)\n  datt$race_us[x] <- datt$race2[x]\n\n  datt <- datt %>% filter(!is.na(race_us)) %>% select(topmed_subject_id, race_us)\n\n  return(datt)\n}\n"
    }
  ]
}
